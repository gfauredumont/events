require 'test_helper'

class MailgunServiceTest < ActiveSupport::TestCase
  test 'total_sent_mail_this_month' do
    domains = { 'items' => [
      { 'created_at' => 'Fri, 16 Jun 2017 17:00:57 GMT', 'name' => 'mg.test.com', 'require_tls' => false, 'skip_verification' => false, 'smtp_login' => 'smtp_login', 'smtp_password' => 'smtp_password', 'spam_action' => 'disabled', 'state' => 'active', 'type' => 'custom', 'web_prefix' => 'email', 'web_scheme' => 'http', 'wildcard' => false },
      { 'created_at' => 'Tue, 22 Nov 2016 14:41:24 GMT', 'name' => 'sandboxd12ec1188b4f479193be5b5052cbc625.mailgun.org', 'require_tls' => false, 'skip_verification' => false, 'smtp_login' => 'smtp_login', 'smtp_password' => 'smtp_password', 'spam_action' => 'disabled', 'state' => 'active', 'type' => 'sandbox', 'web_prefix' => 'email', 'web_scheme' => 'http', 'wildcard' => false }
    ] }

    mgtestcom_stats = { 'end' => 'Sun, 09 Jul 2017 00:00:00 UTC', 'resolution' => 'day', 'start' => 'Sat, 10 Jun 2017 00:00:00 UTC', 'stats' => [{ 'time' => 'Sat, 10 Jun 2017 00:00:00 UTC', 'accepted' => { 'incoming' => 0, 'outgoing' => 0, 'total' => 0 } }, { 'time' => 'Sun, 11 Jun 2017 00:00:00 UTC', 'accepted' => { 'incoming' => 0, 'outgoing' => 0, 'total' => 0 } }, { 'time' => 'Mon, 12 Jun 2017 00:00:00 UTC', 'accepted' => { 'incoming' => 0, 'outgoing' => 0, 'total' => 0 } }, { 'time' => 'Tue, 13 Jun 2017 00:00:00 UTC', 'accepted' => { 'incoming' => 0, 'outgoing' => 0, 'total' => 0 } }, { 'time' => 'Wed, 14 Jun 2017 00:00:00 UTC', 'accepted' => { 'incoming' => 0, 'outgoing' => 0, 'total' => 0 } }, { 'time' => 'Thu, 15 Jun 2017 00:00:00 UTC', 'accepted' => { 'incoming' => 0, 'outgoing' => 0, 'total' => 0 } }, { 'time' => 'Fri, 16 Jun 2017 00:00:00 UTC', 'accepted' => { 'incoming' => 0, 'outgoing' => 0, 'total' => 0 } }, { 'time' => 'Sat, 17 Jun 2017 00:00:00 UTC', 'accepted' => { 'incoming' => 0, 'outgoing' => 0, 'total' => 0 } }, { 'time' => 'Sun, 18 Jun 2017 00:00:00 UTC', 'accepted' => { 'incoming' => 0, 'outgoing' => 0, 'total' => 0 } }, { 'time' => 'Mon, 19 Jun 2017 00:00:00 UTC', 'accepted' => { 'incoming' => 0, 'outgoing' => 0, 'total' => 0 } }, { 'time' => 'Tue, 20 Jun 2017 00:00:00 UTC', 'accepted' => { 'incoming' => 0, 'outgoing' => 3, 'total' => 3 } }, { 'time' => 'Wed, 21 Jun 2017 00:00:00 UTC', 'accepted' => { 'incoming' => 0, 'outgoing' => 0, 'total' => 0 } }, { 'time' => 'Thu, 22 Jun 2017 00:00:00 UTC', 'accepted' => { 'incoming' => 0, 'outgoing' => 0, 'total' => 0 } }, { 'time' => 'Fri, 23 Jun 2017 00:00:00 UTC', 'accepted' => { 'incoming' => 0, 'outgoing' => 0, 'total' => 0 } }, { 'time' => 'Sat, 24 Jun 2017 00:00:00 UTC', 'accepted' => { 'incoming' => 0, 'outgoing' => 0, 'total' => 0 } }, { 'time' => 'Sun, 25 Jun 2017 00:00:00 UTC', 'accepted' => { 'incoming' => 0, 'outgoing' => 0, 'total' => 0 } }, { 'time' => 'Mon, 26 Jun 2017 00:00:00 UTC', 'accepted' => { 'incoming' => 0, 'outgoing' => 0, 'total' => 0 } }, { 'time' => 'Tue, 27 Jun 2017 00:00:00 UTC', 'accepted' => { 'incoming' => 0, 'outgoing' => 0, 'total' => 0 } }, { 'time' => 'Wed, 28 Jun 2017 00:00:00 UTC', 'accepted' => { 'incoming' => 0, 'outgoing' => 1656, 'total' => 1656 } }, { 'time' => 'Thu, 29 Jun 2017 00:00:00 UTC', 'accepted' => { 'incoming' => 0, 'outgoing' => 375, 'total' => 375 } }, { 'time' => 'Fri, 30 Jun 2017 00:00:00 UTC', 'accepted' => { 'incoming' => 0, 'outgoing' => 5, 'total' => 5 } }, { 'time' => 'Sat, 01 Jul 2017 00:00:00 UTC', 'accepted' => { 'incoming' => 0, 'outgoing' => 0, 'total' => 0 } }, { 'time' => 'Sun, 02 Jul 2017 00:00:00 UTC', 'accepted' => { 'incoming' => 0, 'outgoing' => 0, 'total' => 0 } }, { 'time' => 'Mon, 03 Jul 2017 00:00:00 UTC', 'accepted' => { 'incoming' => 0, 'outgoing' => 0, 'total' => 0 } }, { 'time' => 'Tue, 04 Jul 2017 00:00:00 UTC', 'accepted' => { 'incoming' => 0, 'outgoing' => 9, 'total' => 9 } }, { 'time' => 'Wed, 05 Jul 2017 00:00:00 UTC', 'accepted' => { 'incoming' => 0, 'outgoing' => 27, 'total' => 27 } }, { 'time' => 'Thu, 06 Jul 2017 00:00:00 UTC', 'accepted' => { 'incoming' => 4, 'outgoing' => 30, 'total' => 34 } }, { 'time' => 'Fri, 07 Jul 2017 00:00:00 UTC', 'accepted' => { 'incoming' => 0, 'outgoing' => 1, 'total' => 1 } }, { 'time' => 'Sat, 08 Jul 2017 00:00:00 UTC', 'accepted' => { 'incoming' => 0, 'outgoing' => 0, 'total' => 0 } }, { 'time' => 'Sun, 09 Jul 2017 00:00:00 UTC', 'accepted' => { 'incoming' => 0, 'outgoing' => 0, 'total' => 0 } }] }
    sandbox_stats = { 'end' => 'Sun, 09 Jul 2017 00:00:00 UTC', 'resolution' => 'day', 'start' => 'Sat, 10 Jun 2017 00:00:00 UTC', 'stats' => [{ 'time' => 'Sat, 10 Jun 2017 00:00:00 UTC', 'accepted' => { 'incoming' => 0, 'outgoing' => 11, 'total' => 11 } }, { 'time' => 'Sun, 11 Jun 2017 00:00:00 UTC', 'accepted' => { 'incoming' => 0, 'outgoing' => 0, 'total' => 0 } }, { 'time' => 'Mon, 12 Jun 2017 00:00:00 UTC', 'accepted' => { 'incoming' => 0, 'outgoing' => 0, 'total' => 0 } }, { 'time' => 'Tue, 13 Jun 2017 00:00:00 UTC', 'accepted' => { 'incoming' => 0, 'outgoing' => 15, 'total' => 15 } }, { 'time' => 'Wed, 14 Jun 2017 00:00:00 UTC', 'accepted' => { 'incoming' => 0, 'outgoing' => 0, 'total' => 0 } }, { 'time' => 'Thu, 15 Jun 2017 00:00:00 UTC', 'accepted' => { 'incoming' => 0, 'outgoing' => 0, 'total' => 0 } }, { 'time' => 'Fri, 16 Jun 2017 00:00:00 UTC', 'accepted' => { 'incoming' => 0, 'outgoing' => 0, 'total' => 0 } }, { 'time' => 'Sat, 17 Jun 2017 00:00:00 UTC', 'accepted' => { 'incoming' => 0, 'outgoing' => 0, 'total' => 0 } }, { 'time' => 'Sun, 18 Jun 2017 00:00:00 UTC', 'accepted' => { 'incoming' => 0, 'outgoing' => 0, 'total' => 0 } }, { 'time' => 'Mon, 19 Jun 2017 00:00:00 UTC', 'accepted' => { 'incoming' => 0, 'outgoing' => 0, 'total' => 0 } }, { 'time' => 'Tue, 20 Jun 2017 00:00:00 UTC', 'accepted' => { 'incoming' => 0, 'outgoing' => 0, 'total' => 0 } }, { 'time' => 'Wed, 21 Jun 2017 00:00:00 UTC', 'accepted' => { 'incoming' => 0, 'outgoing' => 0, 'total' => 0 } }, { 'time' => 'Thu, 22 Jun 2017 00:00:00 UTC', 'accepted' => { 'incoming' => 0, 'outgoing' => 0, 'total' => 0 } }, { 'time' => 'Fri, 23 Jun 2017 00:00:00 UTC', 'accepted' => { 'incoming' => 0, 'outgoing' => 0, 'total' => 0 } }, { 'time' => 'Sat, 24 Jun 2017 00:00:00 UTC', 'accepted' => { 'incoming' => 0, 'outgoing' => 0, 'total' => 0 } }, { 'time' => 'Sun, 25 Jun 2017 00:00:00 UTC', 'accepted' => { 'incoming' => 0, 'outgoing' => 0, 'total' => 0 } }, { 'time' => 'Mon, 26 Jun 2017 00:00:00 UTC', 'accepted' => { 'incoming' => 0, 'outgoing' => 0, 'total' => 0 } }, { 'time' => 'Tue, 27 Jun 2017 00:00:00 UTC', 'accepted' => { 'incoming' => 0, 'outgoing' => 5, 'total' => 5 } }, { 'time' => 'Wed, 28 Jun 2017 00:00:00 UTC', 'accepted' => { 'incoming' => 0, 'outgoing' => 1, 'total' => 1 } }, { 'time' => 'Thu, 29 Jun 2017 00:00:00 UTC', 'accepted' => { 'incoming' => 0, 'outgoing' => 0, 'total' => 0 } }, { 'time' => 'Fri, 30 Jun 2017 00:00:00 UTC', 'accepted' => { 'incoming' => 0, 'outgoing' => 0, 'total' => 0 } }, { 'time' => 'Sat, 01 Jul 2017 00:00:00 UTC', 'accepted' => { 'incoming' => 0, 'outgoing' => 0, 'total' => 0 } }, { 'time' => 'Sun, 02 Jul 2017 00:00:00 UTC', 'accepted' => { 'incoming' => 0, 'outgoing' => 0, 'total' => 0 } }, { 'time' => 'Mon, 03 Jul 2017 00:00:00 UTC', 'accepted' => { 'incoming' => 0, 'outgoing' => 0, 'total' => 0 } }, { 'time' => 'Tue, 04 Jul 2017 00:00:00 UTC', 'accepted' => { 'incoming' => 0, 'outgoing' => 0, 'total' => 0 } }, { 'time' => 'Wed, 05 Jul 2017 00:00:00 UTC', 'accepted' => { 'incoming' => 0, 'outgoing' => 0, 'total' => 0 } }, { 'time' => 'Thu, 06 Jul 2017 00:00:00 UTC', 'accepted' => { 'incoming' => 0, 'outgoing' => 0, 'total' => 0 } }, { 'time' => 'Fri, 07 Jul 2017 00:00:00 UTC', 'accepted' => { 'incoming' => 0, 'outgoing' => 0, 'total' => 0 } }, { 'time' => 'Sat, 08 Jul 2017 00:00:00 UTC', 'accepted' => { 'incoming' => 0, 'outgoing' => 0, 'total' => 0 } }, { 'time' => 'Sun, 09 Jul 2017 00:00:00 UTC', 'accepted' => { 'incoming' => 0, 'outgoing' => 0, 'total' => 0 } }] }

    Mailgun::Client.any_instance.stubs(:get).with('domains', { limit: 5, skip: 0 }).returns(domains)
    Mailgun::Client.any_instance.stubs(:get).with('mg.test.com/stats/total', event: 'accepted', duration: '30d').returns(mgtestcom_stats)
    Mailgun::Client.any_instance.stubs(:get).with('sandboxd12ec1188b4f479193be5b5052cbc625.mailgun.org/stats/total', event: 'accepted', duration: '30d').returns(sandbox_stats)

    assert_equal 2142, MailgunService.new.total_sent_mail_this_month
  end

  # test "the truth" do
  #   assert true
  # end
end
